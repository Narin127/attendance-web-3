<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ระบบเช็คชื่อนักเรียนอัจฉริยะ</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: #f4f6f9;
  margin: 0;
}

.container {
  padding: 40px;
  max-width: 1200px;
  margin: auto;
}

.card {
  background: white;
  box-shadow: 0 8px 20px rgba(0,0,0,0.08);
  border-radius: 16px;
  padding: 25px;
  text-align: center;
  font-size: 20px;
  flex: 1;
}

.stats {
  display: flex;
  gap: 20px;
}

input {
  padding: 12px;
  border-radius: 12px;
  border: 1px solid #ddd;
  margin: 5px;
  width: 200px;
}

button {
  padding: 12px 20px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  font-weight: bold;
}
</style>
</head>
<body>

<header>
<h2>ระบบเช็คชื่อนักเรียนอัจฉริยะ</h2>
</header>

<div class="container">

<div class="card blue">
มาเรียน
<div id="present">0</div>
</div>

<div class="card yellow">
มาสาย
<div id="late">0</div>
</div>

<div class="card red">
ขาด/ลา
<div id="absent">0</div>
</div>

<br><br>

<h3>เช็คชื่อ</h3>
<h3>สแกนใบหน้า</h3>
<video id="video" width="400" height="300" autoplay muted></video>
<button onclick="startFaceScan()">เริ่มสแกน</button>

<input type="text" id="studentId" placeholder="รหัสนักเรียน">
<input type="text" id="name" placeholder="ชื่อ">
<input type="text" id="class" placeholder="ห้อง">

<br>

<button onclick="check('มาเรียน')">มาเรียน</button>
<button onclick="check('มาสาย')">มาสาย</button>
<button onclick="check('ขาด')">ขาด</button>

<br><br>

<canvas id="chart"></canvas>

</div>

<script>

const URL_APPS_SCRIPT = "https://script.google.com/macros/s/AKfycbx6lm-fM1oTHmIGOObYaQRPNxIz1HzF5_Cw8sFtW8OAYm2g4poJZpgbUp_4yoZJvyfDAA/exec";

function check(status) {

fetch(URL_APPS_SCRIPT, {
method: "POST",
body: JSON.stringify({
studentId: document.getElementById("studentId").value,
name: document.getElementById("name").value,
class: document.getElementById("class").value,
status: status
})
}).then(res => res.json())
.then(data => {
alert("บันทึกแล้ว");
loadData();
});

}

function loadData() {

fetch(URL_APPS_SCRIPT)
.then(res => res.json())
.then(data => {

let present = 0;
let late = 0;
let absent = 0;

for(let i=1; i<data.length; i++){
if(data[i][4] === "มาเรียน") present++;
if(data[i][4] === "มาสาย") late++;
if(data[i][4] === "ขาด") absent++;
}

document.getElementById("present").innerText = present;
document.getElementById("late").innerText = late;
document.getElementById("absent").innerText = absent;

createChart(present, late, absent);

});
}

function createChart(p,l,a) {
new Chart(document.getElementById("chart"), {
type: "doughnut",
data: {
labels: ["มาเรียน","มาสาย","ขาด"],
datasets: [{
data: [p,l,a]
}]
},
options: {
responsive: true,
plugins: {
legend: {
position: 'bottom'
}
}
}
});
}
loadData();
</script>
let labeledDescriptors = [];

async function loadModels() {
  await faceapi.nets.tinyFaceDetector.loadFromUri('/models');
  await faceapi.nets.faceLandmark68Net.loadFromUri('/models');
  await faceapi.nets.faceRecognitionNet.loadFromUri('/models');
}

async function startCamera() {
  const video = document.getElementById("video");
  const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
  video.srcObject = stream;
}

async function startFaceScan() {
  await loadModels();
  await startCamera();

  const video = document.getElementById("video");

  video.addEventListener("play", async () => {
    const detections = await faceapi.detectSingleFace(
      video,
      new faceapi.TinyFaceDetectorOptions()
    ).withFaceLandmarks().withFaceDescriptor();

    if (!detections) return;

    const faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6);
    const bestMatch = faceMatcher.findBestMatch(detections.descriptor);

    if (bestMatch.label !== "unknown") {
      alert("พบ: " + bestMatch.label);
    }
  });
}
</body>
</html>
